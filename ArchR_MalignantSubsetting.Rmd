---
title: "ArchR_MalignantSubsetting"
output: html_document
date: "2024-01-18"
---

```{r}
library(ArchR)
library(Seurat)
addArchRThreads(threads = 1)
#addArchRGenome("hg38")
options(future.globals.maxSize=100000000000000000000000) 
```
Load existing ArchR project
```{r}
archR <- loadArchRProject(path = "/Users/gagled01/morganLab/Waldenstroms/singlecell/data/ATAC_fragments/ArchR_2024_NoProgens")
```
Rerun clustering and batch correction
```{r}
archR <- addIterativeLSI(
  ArchRProj = archR,
  useMatrix = "TileMatrix",
  name = "IterativeLSI_BLineage_NoProgen_Recluster",
  iterations = 2,
  clusterParams = list( # based on Seurat's FindClusters()
    resolution = c(0.25),
    sampleCells = 2000,
    n.start = 10
  ),
  varFeatures = 20000,
  dimsToUse = 1:20,
  force = T
)

archR <- addClusters(
  input = archR,
  reducedDims = "IterativeLSI_BLineage_NoProgen_Recluster",
  method = "Seurat",
  name = "BLin_NoProgen_Clusters",
  resolution = 0.9,
  force = T
)

archR <- addClusters(
  input = archR,
  reducedDims = "IterativeLSI_BLineage_NoProgen_Recluster",
  method = "Seurat",
  name = "BLin_NoProgen_Clusters_2.5",
  resolution = 2.5,
  force = T
)

archR <- addUMAP(
    ArchRProj = archR, 
    reducedDims = "IterativeLSI_BLineage_NoProgen_Recluster", 
    name = "BLineage_NoProgen_Recluster_UMAP", 
    nNeighbors = 30, 
    minDist = 0.5, 
    metric = "cosine",
    force = T
)


p1 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "samplesClean", embedding = "BLineage_NoProgen_Recluster_UMAP")
p2 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "BLin_NoProgen_Clusters", embedding = "BLineage_NoProgen_Recluster_UMAP")
p3 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "predictedGroup_Un", embedding = "BLineage_NoProgen_Recluster_UMAP") 
p4 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "hasTopCDR3", embedding = "BLineage_NoProgen_Recluster_UMAP")
p5 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "condition", embedding = "BLineage_NoProgen_Recluster_UMAP")

plotPDF(p1, p2, p3, p4, p5, name = "WM_2024_BLineageOnly_NoProgens_Reclustered_BasicUMAPs.pdf", ArchRProj = archR, addDOC = FALSE, width = 5, height = 5)
```
Test some marker genes
```{r}
markerGenes <- c("PAX5", "MS4A1", "CD27", "BCL6", "SDC1", "CD38", "CD24", "CD19", "XBP1", "PRDM1", "JCHAIN", "BCL2", "BACH2")

p1 <- plotEmbedding(
    ArchRProj = archR, 
    colorBy = "GeneIntegrationMatrix", 
    name = markerGenes, 
    continuousSet = "solarExtra",
    embedding = "BLineage_NoProgen_Recluster_UMAP",
    imputeWeights = getImputeWeights(archR)
)

#Same plots but overlain with gene scores
p2 <- plotEmbedding(
    ArchRProj = archR,
    colorBy = "GeneScoreMatrix",
    continuousSet = "horizonExtra",
    name = markerGenes,
    embedding = "BLineage_NoProgen_Recluster_UMAP",
    imputeWeights = getImputeWeights(archR)
)
p1
p2
```
# Subclustering WM54 to get cells from the secondary clone to retain from filtering
```{r}
wm54_archR <- patient_recluster(wm54_archR, "WM54") # see TRUST4 annotation script for this code

wm54_archR <- addClusters(
input = wm54_archR,
reducedDims = "Patient_Recluster",
method = "Seurat",
name = "Patient_ReclusterClusters",
resolution = 0.2,
force = TRUE
)

plotEmbedding(ArchRProj = wm54_archR, colorBy = "cellColData", name = "predictedGroup_Un", embedding = "Patient_Recluster_UMAP")
plotEmbedding(ArchRProj = wm54_archR, colorBy = "cellColData", name = "Patient_ReclusterClusters", embedding = "Patient_Recluster_UMAP")

idxKeep <- BiocGenerics::which(wm54_archR$Patient_ReclusterClusters %in% c("C7", "C4"))
cells.WM54.secondClone <- wm54_archR$cellNames[idxKeep]
length(cells.WM54.secondClone)

```
# Illegally subsetting to get list of cells we want to keep for PROPER subsetting below
```{r}
# PCs and MBC from out dataset
idxKeep <- BiocGenerics::which(archR$predictedGroup_Un %in% c("Plasma cells", "Memory B cells") & archR$condition == "WM")
cellsKeep <- archR$cellNames[idxKeep]
# get cells from healthy
idxKeep2 <- BiocGenerics::which(archR$condition == "HD")
cellsKeep2 <- archR$cellNames[idxKeep2]

cellsKeep3 <- c(cellsKeep, cellsKeep2, cells.WM54.secondClone) # add in the weird subclone
length(cellsKeep)
length(cellsKeep2)
length(cellsKeep3)


illegal.archR <- archR[cellsKeep3, ]
```
# and reclustering
```{r}
illegal.archR <- addIterativeLSI(
  ArchRProj = illegal.archR,
  useMatrix = "TileMatrix",
  name = "IterativeLSI_NoProgen_Recluster",
  iterations = 2,
  clusterParams = list( # based on Seurat's FindClusters()
    resolution = c(0.25),
    sampleCells = 2000,
    n.start = 10
  ),
  varFeatures = 20000,
  dimsToUse = 1:20,
  force = T
)

illegal.archR <- addClusters(
  input = illegal.archR,
  reducedDims = "IterativeLSI_NoProgen_Recluster",
  method = "Seurat",
  name = "NoProgen_Clusters",
  resolution = 0.9,
  force = T
)

illegal.archR <- addUMAP(
    ArchRProj = illegal.archR, 
    reducedDims = "IterativeLSI_NoProgen_Recluster", 
    name = "NoProgen_Clusters_UMAP", 
    nNeighbors = 30, 
    minDist = 0.5, 
    metric = "cosine",
    force = T
)
```

```{r}
p1 <- plotEmbedding(ArchRProj = illegal.archR, colorBy = "cellColData", name = "predictedGroup_Un", embedding = "NoProgen_Clusters_UMAP")
p2 <- plotEmbedding(ArchRProj = illegal.archR, colorBy = "cellColData", name = "BLin_Clusters", embedding = "NoProgen_Clusters_UMAP")
p3 <- plotEmbedding(ArchRProj = illegal.archR, colorBy = "cellColData", name = "samplesClean", embedding = "NoProgen_Clusters_UMAP")
p4 <- plotEmbedding(ArchRProj = illegal.archR, colorBy = "cellColData", name = "hasTopCDR3", embedding = "NoProgen_Clusters_UMAP")

plotPDF(p1, p2, p3, p4, name = "WM_ReferenceAddIntegrated_BLineageOnly_NoProgens_Reclustered_BasicUMAPs.pdf", ArchRProj = archR, addDOC = FALSE, width = 5, height = 5)
```
# Check AFF3 and some other marker genes to confirm location of cells to kill
```{r}
markerGenes <- c("AFF3", "BANK1", "CD74", "BCL2", "BACH2")

p1 <- plotEmbedding(
    ArchRProj = illegal.archR, 
    colorBy = "GeneIntegrationMatrix", 
    name = markerGenes, 
    continuousSet = "solarExtra",
    embedding = "NoProgen_Clusters_UMAP",
    imputeWeights = getImputeWeights(illegal.archR)
)

p1
```
# Proper subset for archR project
```{r}
illegal.archR
table(illegal.archR$predictedGroup_Un)
cells.Keep <- illegal.archR$cellNames

cells.Keep <- cellsKeep3

archR.Bcells.MalignantOnly <- subsetArchRProject(ArchRProj = archR,
                   cells = cells.Keep,
                   outputDirectory = "ArchR_2024_NoProgens",
                   dropCells = TRUE,
                   threads = getArchRThreads(),
                   force = TRUE
)
```
Whole dataset approach 
```{r}
archR$annotation1 <- archR$predictedGroup_Un

archR$annotation1[archR$predictedGroup_Un == "Plasma cells"] <- "C1 - Clonal PCs"
archR$annotation1[archR$BLin_NoProgen_Clusters == "C15"] <- "C1 - Clonal PCs"
archR$annotation1[archR$samplesClean != "01-190" & archR$BLin_NoProgen_Clusters == "C14"] <- "C3 - Non-clonal PC"

archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C10"] <- "C2 - Clonal MBC"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C11"] <- "C2 - Clonal MBC"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C12"] <- "C2 - Clonal MBC"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C13"] <- "C2 - Clonal MBC"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C16"] <- "C2 - Clonal MBC"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C17"] <- "C2 - Clonal MBC"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C18"] <- "C2 - Clonal MBC"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C19"] <- "C2 - Clonal MBC"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C20"] <- "C2 - Clonal MBC"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C22"] <- "C2 - Clonal MBC"

archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C24"] <- "C4 - Non-clonal MBC"

archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C21"] <- "C5 - WM54 Secondary Clone"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C23"] <- "C6 - Clonal MBC Minor Cluster 1"
archR$annotation1[archR$predictedGroup_Un != "Plasma cells" & archR$BLin_NoProgen_Clusters == "C25"] <- "C7 - Clonal MBC Minor Cluster 2"

archR$annotation1[archR$predictedGroup_Un %in% c("Large pre-B cells", "Small pre-B cells", "Pro-B cells", "Proliferative germinal center B cells")] <- "C2 - Clonal MBC"

archR$annotation1[archR$condition == "HD" & archR$predictedGroup_Un == "Germinal center B cells"] <- "C8 - HD GC B cells"
archR$annotation1[archR$condition == "HD" & archR$predictedGroup_Un == "Naive B cells"] <- "C9 - HD Naive B cells"
archR$annotation1[archR$condition == "HD" & archR$predictedGroup_Un == "Memory B cells"] <- "C10 - HD Memory B cells"
archR$annotation1[archR$condition == "HD" & archR$predictedGroup_Un == "Plasma cells"] <- "C11 - HD Plasma cells"

archR$annotation1[archR$annotation1 == "Memory B cells"] <- "C2 - Clonal MBC"


#plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "annotation1", embedding = "BLineage_NoProgen_Recluster_UMAP")


```

```{r}
theme <- theme_ArchR(legendTextSize = 8, legendPosition = "right")

p1 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "samplesClean", embedding = "BLineage_NoProgen_Recluster_UMAP", legendSize = 2) 
p2 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "BLin_NoProgen_Clusters", embedding = "BLineage_NoProgen_Recluster_UMAP", legendSize = 2)
p3 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "predictedGroup_Un", embedding = "BLineage_NoProgen_Recluster_UMAP", legendSize = 2) 
p4 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "annotation1", embedding = "BLineage_NoProgen_Recluster_UMAP", legendSize = 4) 
p5 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "hasTopCDR3", embedding = "BLineage_NoProgen_Recluster_UMAP", legendSize = 2)
p6 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "condition", embedding = "BLineage_NoProgen_Recluster_UMAP", legendSize = 2)
p7 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "hasPC", embedding = "BLineage_NoProgen_Recluster_UMAP", legendSize = 2)
p8 <- plotEmbedding(ArchRProj = archR, colorBy = "cellColData", name = "cxcr4", embedding = "BLineage_NoProgen_Recluster_UMAP", legendSize = 2)

#ggsave(p1, "/Users/gagled01/morganLab/Waldenstroms/singlecell/data/ATAC_fragments/ArchR_2024_NoProgens/Plots/test.png", height = 6, width = 6)
#plotPDF(p1, name = "test.pdf", ArchRProj = archR, addDOC = FALSE, width = 5, height = 5)

plotPDF(p1, p2, p3, p4, p5, p6, p7, p8, name = "WM_2024_BLineageOnly_NoProgens_Reclustered_BasicUMAPs.pdf", ArchRProj = archR, addDOC = FALSE, width = 6, height = 6)
```
Save it out
```{r}
saveArchRProject(ArchRProj = archR, outputDirectory = "WM_2024_BaselineData", load = F)
```
# PSEUDO BULK REPLICATES
```{r}
library("BSgenome.Hsapiens.UCSC.hg38")

archR <- addGroupCoverages(ArchRProj = archR, groupBy = "BLin_NoProgen_Clusters",
                                minRep = 2, maxReplicates = 5, minCells = 40, maxCells = 500, sampleRatio = 0.8)

archR <- addReproduciblePeakSet(
    ArchRProj = archR, 
    groupBy = "BLin_NoProgen_Clusters"
)

archR <- addPeakMatrix(archR)

saveArchRProject(ArchRProj = archR, outputDirectory = "WM_2024_PeaksAdded", load = F)
```
# ADD PEAKS AND GET MATRIX
```{r}

```
